<script>
    // ========== CONFIGURA√á√ÉO DO SISTEMA ==========
    const API_BASE = '/api';

    // Banco de dados inicial de jogadores
    const playerDatabase = {
        'FG-8V501Y': {
            name: 'KADU',
            origin: 'KUROGANE',
            profile: 'ADULTO',
            nature: 'MAGO',
            motivation: 'SALVAR ALGU√âM QUE PERDI',
            servant: {
                class: 'SABER',
                name: 'CLASSIFICADO',
                alignment: 'LEAL E BOM',
                bond: 'INICIAL'
            }
        },
        'FG-TEST01': {
            name: 'JOGADOR TESTE',
            origin: 'EXTERNA',
            profile: 'ESTUDANTE',
            nature: 'HUMANO COMUM',
            motivation: 'MUDAR O MUNDO',
            servant: {
                class: 'ARCHER',
                name: 'CLASSIFICADO',
                alignment: 'NEUTRO',
                bond: 'INICIAL'
            }
        }
    };

    // ========== FUN√á√ïES DE BACKEND ==========
    async function saveToBackend(playerData) {
        const playerCode = sessionStorage.getItem('currentUser');

        try {
            const response = await fetch(`${API_BASE}/save-player`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    playerCode: playerCode,
                    playerData: playerData
                })
            });

            const result = await response.json();

            if (result.success) {
                console.log('‚úÖ Dados salvos no MongoDB!');
                return true;
            } else {
                console.warn('‚ö†Ô∏è Problema ao salvar no servidor');
                return false;
            }
        } catch (error) {
            console.warn('üåê Servidor offline, salvando apenas localmente', error);
            return false;
        }
    }

    async function loadFromBackend(playerCode) {
        try {
            const response = await fetch(`${API_BASE}/get-player?code=${playerCode}`);
            const result = await response.json();

            if (result.success && result.data) {
                console.log('‚úÖ Dados carregados do MongoDB!');
                return result.data;
            }
        } catch (error) {
            console.warn('üåê Servidor offline, carregando do localStorage', error);
        }

        return null;
    }

    async function testBackendConnection() {
        try {
            const response = await fetch(`${API_BASE}/get-player?code=FG-8V501Y`);
            if (response.ok) {
                console.log('‚úÖ Backend conectado!');
                return true;
            }
        } catch (error) {
            console.warn('‚ùå Backend offline:', error && error.message);
        }
        return false;
    }

    // ========== FUN√á√ïES DO SISTEMA ==========
    function createMatrixRain() {
        const matrixRain = document.getElementById('matrixRain');
        if (!matrixRain) return;

        for (let i = 0; i < 50; i++) {
            const span = document.createElement('span');
            span.innerText = Math.random() > 0.5 ? '1' : '0';
            span.style.left = Math.random() * 100 + '%';
            span.style.animationDelay = Math.random() * 5 + 's';
            matrixRain.appendChild(span);
        }
    }

    // DOM references (assigned after DOM ready)
    let loginScreen, dashboard, codeInput, loginBtn, logoutBtn, userGreeting, userCode;
    let tabs, panels;
    let profileEditButtons;
    let addQuestBtn, questTitleInput, questDescriptionInput, questList;

    // Login Function
    async function login() {
        if (!codeInput) {
            console.error('login: codeInput is not available');
            return;
        }

        const code = codeInput.value.trim().toUpperCase();

        if (playerDatabase[code]) {
            const player = playerDatabase[code];

            // Tenta carregar do backend primeiro
            const savedData = await loadFromBackend(code);
            if (savedData) {
                Object.assign(player, savedData);
            } else {
                // Fallback para localStorage
                const localData = localStorage.getItem(`playerData_${code}`);
                if (localData) {
                    Object.assign(player, JSON.parse(localData));
                }
            }

            // Load quests from localStorage
            const savedQuests = localStorage.getItem(`quests_${code}`);
            if (savedQuests) {
                displayQuests(JSON.parse(savedQuests));
            } else if (questList) {
                displayQuests([]);
            }

            // Update UI with player data
            updateProfileDisplay(player);

            if (userGreeting) userGreeting.textContent = `BEM-VINDO, ${player.name}`;
            if (userCode) userCode.textContent = `C√ìDIGO: ${code}`;

            // Switch to dashboard
            if (loginScreen) loginScreen.style.display = 'none';
            if (dashboard) dashboard.style.display = 'flex';

            // Store current user in session
            sessionStorage.setItem('currentUser', code);

            // Re-inicializa event listeners para elementos que agora existem
            initializeProfileEventListeners();
        } else {
            alert('C√ìDIGO DE ACESSO INV√ÅLIDO. TENTE NOVAMENTE.');
            if (codeInput) {
                codeInput.value = '';
                codeInput.focus();
            }
        }
    }

    function updateProfileDisplay(player) {
        const elements = {
            'profile-name': player.name,
            'profile-origin': player.origin,
            'profile-type': player.profile,
            'profile-nature': player.nature,
            'profile-motivation': player.motivation,
            'servant-class': player.servant && player.servant.class,
            'servant-name': player.servant && player.servant.name,
            'servant-alignment': player.servant && player.servant.alignment,
            'servant-bond': player.servant && player.servant.bond
        };

        for (const [id, value] of Object.entries(elements)) {
            const element = document.getElementById(id);
            if (element) element.textContent = value || '';
        }
    }

    function logout() {
        sessionStorage.removeItem('currentUser');
        if (dashboard) dashboard.style.display = 'none';
        if (loginScreen) loginScreen.style.display = 'flex';
        if (codeInput) {
            codeInput.value = '';
            codeInput.focus();
        }
    }

    // Profile Edit Functions
    function initializeProfileEventListeners() {
        const currentEditProfileBtn = document.getElementById('edit-profile-btn');
        const currentSaveProfileBtn = document.getElementById('save-profile-btn');
        const currentCancelEditBtn = document.getElementById('cancel-edit-btn');

        if (!currentEditProfileBtn && !currentSaveProfileBtn && !currentCancelEditBtn) {
            console.warn('initializeProfileEventListeners: no profile buttons found');
            return;
        }

        if (currentEditProfileBtn) {
            currentEditProfileBtn.addEventListener('click', () => {
                const currentUser = sessionStorage.getItem('currentUser');
                const player = playerDatabase[currentUser] || {};

                const setValueSafely = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.value = value || '';
                };

                setValueSafely('edit-profile-name', player.name);
                setValueSafely('edit-profile-origin', player.origin);
                setValueSafely('edit-profile-type', player.profile);
                setValueSafely('edit-profile-nature', player.nature);
                setValueSafely('edit-profile-motivation', player.motivation);

                document.querySelectorAll('.profile-value').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.edit-input').forEach(el => el.style.display = 'block');

                if (profileEditButtons) profileEditButtons.style.display = 'flex';
                currentEditProfileBtn.style.display = 'none';
            });
        }

        if (currentSaveProfileBtn) {
            currentSaveProfileBtn.addEventListener('click', saveProfile);
        }

        if (currentCancelEditBtn) {
            currentCancelEditBtn.addEventListener('click', () => {
                document.querySelectorAll('.profile-value').forEach(el => el.style.display = 'block');
                document.querySelectorAll('.edit-input').forEach(el => el.style.display = 'none');
                if (profileEditButtons) profileEditButtons.style.display = 'none';
                if (currentEditProfileBtn) currentEditProfileBtn.style.display = 'block';
            });
        }
    }

    async function saveProfile() {
        const currentUser = sessionStorage.getItem('currentUser');
        if (!currentUser) {
            console.error('saveProfile: no current user in session');
            return;
        }
        const player = playerDatabase[currentUser];

        player.name = (document.getElementById('edit-profile-name') || {}).value || player.name;
        player.origin = (document.getElementById('edit-profile-origin') || {}).value || player.origin;
        player.profile = (document.getElementById('edit-profile-type') || {}).value || player.profile;
        player.nature = (document.getElementById('edit-profile-nature') || {}).value || player.nature;
        player.motivation = (document.getElementById('edit-profile-motivation') || {}).value || player.motivation;

        const playerDataToSave = {
            name: player.name,
            origin: player.origin,
            profile: player.profile,
            nature: player.nature,
            motivation: player.motivation,
            servant: player.servant
        };

        const backendSuccess = await saveToBackend(playerDataToSave);
        localStorage.setItem(`playerData_${currentUser}`, JSON.stringify(playerDataToSave));

        if (backendSuccess) {
            alert('‚úÖ Dados salvos no servidor!');
        } else {
            alert('‚ö†Ô∏è Dados salvos localmente (servidor offline)');
        }

        updateProfileDisplay(player);

        document.querySelectorAll('.profile-value').forEach(el => el.style.display = 'block');
        document.querySelectorAll('.edit-input').forEach(el => el.style.display = 'none');

        if (profileEditButtons) profileEditButtons.style.display = 'none';
        const currentEditProfileBtn = document.getElementById('edit-profile-btn');
        if (currentEditProfileBtn) currentEditProfileBtn.style.display = 'block';

        if (userGreeting) userGreeting.textContent = `BEM-VINDO, ${player.name}`;
    }

    // Quest Functions
    function addQuest() {
        if (!questTitleInput) {
            console.error('addQuest: quest inputs are not available');
            return;
        }

        const title = questTitleInput.value.trim();
        const description = questDescriptionInput ? questDescriptionInput.value.trim() : '';

        if (!title) {
            alert('Por favor, insira um t√≠tulo para a miss√£o.');
            return;
        }

        const currentUser = sessionStorage.getItem('currentUser');
        if (!currentUser) {
            alert('Nenhum usu√°rio logado.');
            return;
        }

        const quests = JSON.parse(localStorage.getItem(`quests_${currentUser}`)) || [];

        const newQuest = {
            id: Date.now(),
            title: title,
            description: description,
            status: 'active',
            createdAt: new Date().toLocaleDateString('pt-BR')
        };

        quests.push(newQuest);
        localStorage.setItem(`quests_${currentUser}`, JSON.stringify(quests));

        displayQuests(quests);

        questTitleInput.value = '';
        if (questDescriptionInput) questDescriptionInput.value = '';
    }

    function displayQuests(quests) {
        if (!questList) return;

        questList.innerHTML = '';

        if (!Array.isArray(quests) || quests.length === 0) {
            questList.innerHTML = '<div class="profile-item">Nenhuma miss√£o criada ainda.</div>';
            return;
        }

        quests.forEach(quest => {
            const questItem = document.createElement('div');
            questItem.className = 'quest-item';
            questItem.innerHTML = `
                <div class="quest-header">
                    <div class="quest-title">${escapeHtml(String(quest.title))}</div>
                    <div class="quest-status ${quest.status === 'active' ? 'status-active' : 'status-completed'}">
                        ${quest.status === 'active' ? 'ATIVA' : 'CONCLU√çDA'}
                    </div>
                </div>
                <div class="quest-description">${escapeHtml(String(quest.description || ''))}</div>
                <div class="profile-label">Criada em: ${escapeHtml(String(quest.createdAt || ''))}</div>
                <div class="quest-actions">
                    <button class="btn btn-small toggle-quest-btn" data-id="${quest.id}">
                        ${quest.status === 'active' ? 'MARCAR COMO CONCLU√çDA' : 'REATIVAR MISS√ÉO'}
                    </button>
                    <button class="btn btn-small delete-quest-btn" data-id="${quest.id}">EXCLUIR</button>
                </div>
            `;
            questList.appendChild(questItem);
        });

        document.querySelectorAll('.toggle-quest-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const questId = parseInt(btn.getAttribute('data-id'));
                toggleQuestStatus(questId);
            });
        });

        document.querySelectorAll('.delete-quest-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const questId = parseInt(btn.getAttribute('data-id'));
                deleteQuest(questId);
            });
        });
    }

    function toggleQuestStatus(questId) {
        const currentUser = sessionStorage.getItem('currentUser');
        if (!currentUser) return;
        const quests = JSON.parse(localStorage.getItem(`quests_${currentUser}`)) || [];

        const questIndex = quests.findIndex(q => q.id === questId);
        if (questIndex !== -1) {
            quests[questIndex].status = quests[questIndex].status === 'active' ? 'completed' : 'active';
            localStorage.setItem(`quests_${currentUser}`, JSON.stringify(quests));
            displayQuests(quests);
        }
    }

    function deleteQuest(questId) {
        const currentUser = sessionStorage.getItem('currentUser');
        if (!currentUser) return;
        let quests = JSON.parse(localStorage.getItem(`quests_${currentUser}`)) || [];

        quests = quests.filter(q => q.id !== questId);
        localStorage.setItem(`quests_${currentUser}`, JSON.stringify(quests));
        displayQuests(quests);
    }

    // Simple HTML escaper to avoid accidental injection
    function escapeHtml(str) {
        return str.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ========== EVENT LISTENERS CORRIGIDOS ==========
    function initializeEventListeners() {
        console.log('üîÑ Inicializando event listeners...');

        // Login/Logout
        if (loginBtn) {
            loginBtn.addEventListener('click', login);
            console.log('‚úÖ loginBtn event listener adicionado');
        } else {
            console.warn('loginBtn n√£o encontrado');
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', logout);
            console.log('‚úÖ logoutBtn event listener adicionado');
        } else {
            console.warn('logoutBtn n√£o encontrado');
        }

        // Quests
        if (addQuestBtn) {
            addQuestBtn.addEventListener('click', addQuest);
            console.log('‚úÖ addQuestBtn event listener adicionado');
        } else {
            console.warn('addQuestBtn n√£o encontrado');
        }

        // Keyboard events
        if (codeInput) {
            codeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
        }

        if (questTitleInput) {
            questTitleInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addQuest();
            });
        }

        // Tab switching
        if (tabs && tabs.length > 0) {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    if (panels && panels.length > 0) panels.forEach(p => p.classList.remove('active'));

                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    const panel = document.getElementById(`${tabId}-panel`);
                    if (panel) panel.classList.add('active');
                });
            });
        } else {
            console.warn('Nenhuma aba encontrada (tabs).');
        }

        console.log('‚úÖ Todos os event listeners inicializados');
    }

    // ========== INICIALIZA√á√ÉO ==========
    window.addEventListener('load', async () => {
        console.log('üöÄ Iniciando aplica√ß√£o...');

        // Assign DOM references now that DOM is ready
        loginScreen = document.getElementById('login-screen');
        dashboard = document.getElementById('dashboard');
        codeInput = document.getElementById('code-input');
        loginBtn = document.getElementById('login-btn');
        logoutBtn = document.getElementById('logout-btn');
        userGreeting = document.getElementById('user-greeting');
        userCode = document.getElementById('user-code');
        tabs = document.querySelectorAll('.tab');
        panels = document.querySelectorAll('.content-panel');
        profileEditButtons = document.getElementById('profile-edit-buttons');
        addQuestBtn = document.getElementById('add-quest-btn');
        questTitleInput = document.getElementById('quest-title');
        questDescriptionInput = document.getElementById('quest-description');
        questList = document.getElementById('quest-list');

        createMatrixRain();
        await testBackendConnection();

        // Inicializa event listeners
        initializeEventListeners();

        // Verifica se j√° est√° logado
        const currentUser = sessionStorage.getItem('currentUser');
        if (currentUser && playerDatabase[currentUser]) {
            if (codeInput) codeInput.value = currentUser;
            // call login safely
            await login();
        } else {
            if (codeInput) codeInput.focus();
        }

        console.log('‚úÖ Aplica√ß√£o iniciada com sucesso!');
    });
</script>
